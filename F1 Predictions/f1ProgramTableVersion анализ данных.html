<html>
	<head>
		<link rel="stylesheet" href = "css/f1Analysis.css" >
		<script src = "scripts/f1Analysis.js" ></script>
		<script src = "scripts/FileSystem.js" ></script>
		<script src = "scripts/Statistics.js" ></script>
		<script>
		onload = () => {
			// Данные для анализа.
			const data = [];
			// Статистические величины.
			const indicators = [];
			
			// Загрузить данные из файла.
			document.getElementById("loadResults").addEventListener("input", e => {
				new FS().loadFile(e.target.files[0]).then(results => {
					document.getElementById("bestLapsPoints").value = results;
				});
			});
			// Посчитать средние значения.
			document.querySelector("#caluculate").addEventListener("click", () => {
				getStats();
				//indicators.sort(sortByMean);
				drawTable();
				addListeners();
			});

			// Посчитать статистические показатели.
			const getStats = () => {
				const weightValue = [];
				document.querySelector("#bestLapsPoints").value.split("\n").forEach(racer => {
					data.push(racer.split(/,\s*/));
				});
				// Рассчитать веса показателей. Свежие данные имеют больший вес.
				for(let i = 1, count = data[0].length; i <= count; i++){
					weightValue.push(1 / count * i);
				}
				// Расчет.
				data.forEach((racer, i) => {
					const driver = racer.shift();
					const stats = new Statistics(racer.map(Number));
					const line = stats.getTrendLine();
					const trend = stats.toRound(line.k * stats.data.length + line.b);
					indicators.push(
						[driver, stats.getMean(), stats.getAverage(weightValue), stats.getModa(),
						stats.getMedian(), stats.getSquare(), trend]
					);
				});
			}

			// Добавить функции-слушатели к таблице.
			const addListeners = () => {
				const tr = document.getElementsByTagName("tr")[0];
				for(let i = 1; i < tr.children.length; i++){
					tr.children[i].addEventListener("click", () => {
						indicators.sort(sorter[i - 1]);
						drawTable();
						addListeners();
					});
				}
			}

			// Генерация таблицы.
			const drawTable = () => {
				
				let table = "<table><tr><td>Пилот</td><td>Средняя арифметическая</td><td>Взвешенная</td>\
							<td>Мода</td><td>Медиана</td><td>Отклонение</td><td>Тренд</td></tr>";
				indicators.forEach((value, i) => {
					table += `<tr><td>${value[0]}</td>`;
					table +=`<td>${value[1]}</td>`;
					table +=`<td>${value[2]}</td>`;
					table +=`<td>${value[3]}</td>`;
					table +=`<td>${value[4]}</td>`;
					table +=`<td>${value[5]}</td>`;
					table +=`<td>${value[6]}</td>`;
					table += "</tr>";
				});
				document.getElementById("results").innerHTML = table + "</table>";
			}
			
			// Сортировка по среднеарифметической.
			const sortByMean = (first, second) => {
				return second[1] - first[1];
			}
			// Сортировка по средневзвешанной.
			const sortByAverage = (first, second) => {
				return second[2] - first[2];
			}
			// Сортировка по моде.
			const sortByModa = (first, second) => {
				return second[3][second[3].length - 1] - first[3][first[3].length - 1];
			}
			// Сортировка по медиане.
			const sortByMedian = (first, second) => {
				return second[4] - first[4];
			}
			// Сортировка по отклонению.
			const sortBySquare = (first, second) => {
				return second[5] - first[5];
			}
			// Сортировка по тренду.
			const sortByTrend = (first, second) => {
				return second[6] - first[6];
			}
			// Массив функций сортировка.
			const sorter = [sortByMean, sortByAverage, sortByModa, sortByMedian, sortBySquare, sortByTrend];
		
		
			// Вычисления на ходу.
			const calculateStatistics = () => {
				// Проверка числовых данных.
				let data = [];
				document.querySelector("#bestLapsPoints").value.split("\n").forEach(racer => {
					data.push(racer.split(/,\s*/));
				});
				let peaces = [];
				for(let i = 1, count = data[0].length; i <= count; i++){
					peaces.push(1 / count * i);
				}
				let table = "<table><tr><td>Пилот</td><td>Средняя арифметическая</td><td>Взвешенная</td><td>Мода</td><td>Медиана</td><td>Отклонение</td><td>Тренд</td></tr>";
				data.forEach((value, i) => {
					table += `<tr><td>${value[0]}</td>`;
					value.shift();
					const stats = new Statistics(value.map(Number));
					const line = stats.getTrendLine();
					const trend = line.k * stats.data.length + line.b;
					table +=`<td>${stats.getMean()}</td>`;
					table +=`<td>${stats.getAverage(peaces)}</td>`;
					table +=`<td>${stats.getModa()}</td>`;
					table +=`<td>${stats.getMedian()}</td>`;
					table +=`<td>${stats.getSquare()}</td>`;
					table +=`<td>${trend}</td>`;
					table += "</tr>";
				});
				document.getElementById("results").innerHTML = table + "</table>";
			}
		}
		</script>
	</head>
	<body>
		<input id = "loadResults" type = "file" value = "Загрузить результаты">
		<div id = "teams">
			<textarea id = "practicePoints"></textarea>
			<textarea id = "qualificationsPoints"></textarea>
			<textarea id = "bestLapsPoints"></textarea>
		</div>
		<div id = "results"></div>
		<button id="caluculate">Считать</button>
	</body>
</html>